<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trantourist Assistant</title>
  <style>
    :root{
      --bg:#0b0b0c; --panel:#121214; --bubble:#1f1f23; --me:#3a3a45;
      --text:#eee; --muted:#9aa0a6; --accent:#7c5cff;
    }
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui;}
    .app{max-width:520px;margin:16px auto;border-radius:16px;overflow:hidden;background:var(--panel);box-shadow:0 8px 30px rgba(0,0,0,.45)}
    .top{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #222;}
    .dot{width:8px;height:8px;border-radius:50%;background:#2bdc73;}
    .title{font-weight:600}
    .lang{margin-left:auto;color:var(--muted);font-size:13px}
    .chat{height:70vh;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px}
    .row.me{justify-content:flex-end}
    .bubble{max-width:78%;padding:10px 12px;border-radius:14px;background:var(--bubble)}
    .row.me .bubble{background:var(--me)}
    .meta{font-size:11px;color:var(--muted);margin-top:4px}
    .bottom{display:flex;gap:8px;padding:10px;border-top:1px solid #222;}
    input{flex:1;background:#0f0f12;border:1px solid #222;border-radius:10px;padding:10px;color:var(--text);outline:none}
    button{background:#0f0f12;border:1px solid #222;color:var(--text);border-radius:10px;padding:0 12px;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="dot"></div>
      <div class="title">Trantourist Assistant</div>
      <div class="lang" id="status">disconnected</div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="bottom">
      <input id="msg" placeholder="Type a message‚Ä¶"/>
      <button id="send">Send</button>
      <button id="call" class="primary">üìû New Call</button>
      <button id="hangup">Hang up</button>
    </div>
  </div>

<script>
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const callBtn = document.getElementById("call");
const hangBtn = document.getElementById("hangup");
const statusEl = document.getElementById("status");

let ws = null;
let audioQueue = [];
let playing = false;
let micCtx = null;
let micStream = null;

// ---------- UI ----------
function addBubble(text, who="ai"){
  const row = document.createElement("div");
  row.className = "row " + (who==="me" ? "me": "ai");
  const b = document.createElement("div");
  b.className = "bubble";
  b.textContent = text;
  row.appendChild(b);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}
function setStatus(s){ statusEl.textContent=s; }

// ---------- get signed ws url ----------
async function getWsUrl(){
  const r = await fetch("/api/get-ws-url", {method:"POST"});
  const j = await r.json();
  if(!j.ws_url) throw new Error(j.error||"no ws_url");
  return j.ws_url;
}

// ---------- audio playback ----------
async function playBase64Audio(b64, mime="audio/mpeg"){
  audioQueue.push({b64, mime});
  if(playing) return;
  playing = true;

  while(audioQueue.length){
    const {b64, mime} = audioQueue.shift();
    const bytes = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
    const blob = new Blob([bytes], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = new Audio(url);
    await a.play().catch(()=>{});
    await new Promise(r=> a.onended=r);
    URL.revokeObjectURL(url);
  }
  playing = false;
}

// ---------- WS helpers ----------
function wsSend(obj){
  if(ws && ws.readyState===1){
    ws.send(JSON.stringify(obj));
  }
}

function connectWs(wsUrl){
  ws = new WebSocket(wsUrl);

  ws.onopen = async ()=>{
    setStatus("connected");

    // ‚úÖ B·∫ÆT BU·ªòC: init conversation
    wsSend({ type: "conversation_initiation_client_data" });

    addBubble("Hey there. I'm your ElevenLabs agent. How can I help you today?","ai");

    // ‚úÖ ch·ªâ start mic sau khi WS open
    await startMicPCM();
  };

  ws.onclose = ()=>{
    setStatus("disconnected");
  };
  ws.onerror = (e)=>{
    console.error("ws error", e);
  };

  ws.onmessage = async (ev)=>{
    let data;
    try{ data = JSON.parse(ev.data); }catch{ return; }

    // ‚úÖ ping -> pong
    if (data.type === "ping") {
      wsSend({ type: "pong", event_id: data.ping_event?.event_id });
      return;
    }

    // ‚úÖ text agent tr·∫£ v·ªÅ
    if (data.type === "agent_response") {
      const t = data.agent_response_event?.agent_response;
      if (t) addBubble(t, "ai");
      return;
    }

    // ‚úÖ audio agent tr·∫£ v·ªÅ
    if (data.type === "audio") {
      const b64 = data.audio_event?.audio_base_64;
      if (b64) await playBase64Audio(b64, "audio/mpeg");
      return;
    }

    // Debug n·∫øu c·∫ßn:
    // console.log("WS <-", data);
  };
}

// ---------- PCM mic streaming (worklet) ----------
async function startMicPCM() {
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

  // ‚úÖ match user_input_audio_format = pcm_16000
  micCtx = new AudioContext({ sampleRate: 16000 });

  await micCtx.audioWorklet.addModule("/pcm-worklet.js");

  const src = micCtx.createMediaStreamSource(micStream);
  const worklet = new AudioWorkletNode(micCtx, "pcm-worklet");

  worklet.port.onmessage = (ev) => {
    const b64 = ev.data; // PCM16 @16kHz base64
    wsSend({ user_audio_chunk: b64 }); // ‚úÖ ƒë√∫ng schema
  };

  src.connect(worklet); // kh√¥ng n·ªëi ra loa ƒë·ªÉ kh·ªèi echo
}


function stopMicPCM() {
  if (micStream) micStream.getTracks().forEach(t => t.stop());
  if (micCtx) micCtx.close();
  micStream = null;
  micCtx = null;
}

// ---------- UI events ----------
callBtn.onclick = async ()=>{
  callBtn.disabled = true;
  try{
    const wsUrl = await getWsUrl();
    connectWs(wsUrl);
  }catch(err){
    console.error(err);
    addBubble("Failed to start call: "+err.message,"ai");
    callBtn.disabled=false;
  }
};

hangBtn.onclick = ()=>{
  stopMicPCM();
  if(ws) ws.close();
  ws=null;
  callBtn.disabled=false;
};

sendBtn.onclick = ()=>{
  const text = msgInput.value.trim();
  if(!text) return;

  addBubble(text, "me");
  msgInput.value="";

  // ‚úÖ format text cho ConvAI WS (ph·ªï bi·∫øn)
  wsSend({
    type: "user_message",
    text
  });
};

msgInput.addEventListener("keydown", (e)=>{
  if(e.key==="Enter") sendBtn.click();
});
</script>
</body>
</html>
